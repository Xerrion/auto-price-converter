name: Publish to Chrome Web Store

on:
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Get latest release
        id: release
        uses: pozetroninc/github-action-get-latest-release@master
        with:
          repository: ${{ github.repository }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract version
        id: version
        run: |
          # Tag format: auto-price-converter-v2.3.0 -> extract 2.3.0
          VERSION=$(echo "$RELEASE_TAG" | sed 's/.*-v//')
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        env:
          RELEASE_TAG: ${{ steps.release.outputs.release }}

      - name: Download release asset
        run: |
          gh release download "${{ steps.release.outputs.release }}" \
            --pattern "auto-price-converter-${{ steps.version.outputs.VERSION }}-chrome.zip" \
            --repo "${{ github.repository }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload and publish to Chrome Web Store
        uses: mobilefirstllc/cws-publish@latest
        with:
          action: publish
          client_id: ${{ secrets.CHROME_CLIENT_ID }}
          client_secret: ${{ secrets.CHROME_CLIENT_SECRET }}
          refresh_token: ${{ secrets.CHROME_REFRESH_TOKEN }}
          extension_id: ${{ secrets.CHROME_EXTENSION_ID }}
          zip_file: auto-price-converter-${{ steps.version.outputs.VERSION }}-chrome.zip

      - name: Confirmation
        run: echo "Chrome extension v${{ steps.version.outputs.VERSION }} submitted for Chrome Web Store review!"
