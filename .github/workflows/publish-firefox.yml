name: Publish to Firefox Add-ons

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "publish" to confirm'
        required: true
        default: ""

jobs:
  publish:
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm == 'publish'

    steps:
      - name: Get latest release
        id: release
        uses: pozetroninc/github-action-get-latest-release@master
        with:
          repository: ${{ github.repository }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract version
        id: version
        run: |
          # Tag format: auto-price-converter-v2.3.0 -> extract 2.3.0
          VERSION=$(echo "$RELEASE_TAG" | sed 's/.*-v//')
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        env:
          RELEASE_TAG: ${{ steps.release.outputs.release }}

      - name: Download release asset
        run: |
          gh release download "${{ steps.release.outputs.release }}" \
            --pattern "extension-firefox-${{ steps.version.outputs.VERSION }}.zip" \
            --repo "${{ github.repository }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload and publish to Firefox Add-ons
        uses: wdzeng/firefox-addon@v1
        with:
          addon-guid: auto-price-converter@xerrion.dev
          xpi-path: extension-firefox-${{ steps.version.outputs.VERSION }}.zip
          jwt-issuer: ${{ secrets.FIREFOX_JWT_ISSUER }}
          jwt-secret: ${{ secrets.FIREFOX_JWT_SECRET }}

      - name: Confirmation
        run: echo "Firefox extension v${{ steps.version.outputs.VERSION }} submitted for Firefox Add-ons review!"
