name: Publish to Firefox Add-ons

on:
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Get latest release
        id: release
        uses: pozetroninc/github-action-get-latest-release@master
        with:
          repository: ${{ github.repository }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract version
        id: version
        run: |
          VERSION=$(echo "$RELEASE_TAG" | sed 's/.*-v//')
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        env:
          RELEASE_TAG: ${{ steps.release.outputs.release }}

      - name: Download release asset
        run: |
          gh release download "${{ steps.release.outputs.release }}" \
            --pattern "auto-price-converter-${{ steps.version.outputs.VERSION }}-firefox.zip" \
            --repo "${{ github.repository }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload and publish to Firefox Add-ons
        uses: wdzeng/firefox-addon@v1
        with:
          addon-guid: auto-price-converter@xerrion.dev
          xpi-path: auto-price-converter-${{ steps.version.outputs.VERSION }}-firefox.zip
          jwt-issuer: ${{ secrets.FIREFOX_JWT_ISSUER }}
          jwt-secret: ${{ secrets.FIREFOX_JWT_SECRET }}

      - name: Confirmation
        run: echo "Firefox extension v${{ steps.version.outputs.VERSION }} submitted for Firefox Add-ons review!"
